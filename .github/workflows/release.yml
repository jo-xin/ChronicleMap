name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-windows-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: python -m pip install --upgrade pip && pip install poetry

      - name: Install dependencies
        run: |
          poetry config virtualenvs.create false
          poetry install --no-interaction --no-ansi

      - name: Resolve release version from tag
        run: |
          "VERSION=$($env:GITHUB_REF_NAME.TrimStart('v'))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Validate version matches tag
        run: |
          @'
          import pathlib
          import re
          import sys
          import tomllib

          tag_version = sys.argv[1]
          pyproject = tomllib.loads(pathlib.Path("pyproject.toml").read_text(encoding="utf-8"))
          project_version = pyproject.get("project", {}).get("version")
          if not project_version:
            raise SystemExit("Missing [project].version in pyproject.toml")

          init_text = pathlib.Path("chroniclemap/__init__.py").read_text(encoding="utf-8")
          m = re.search(r'__version__\s*=\s*"([^"]+)"', init_text)
          if not m:
            raise SystemExit("Missing __version__ in chroniclemap/__init__.py")
          init_version = m.group(1)

          if tag_version != project_version or tag_version != init_version:
            raise SystemExit(
              f"Version mismatch: tag={tag_version}, pyproject={project_version}, __init__={init_version}"
            )
          print(f"Version OK: {tag_version}")
          '@ | python - "${env:VERSION}"

      - name: Build onefile executable
        run: |
          poetry run python -m PyInstaller `
            --noconfirm `
            --clean `
            --windowed `
            --onefile `
            --name ChronicleMap `
            --distpath dist_onefile `
            --workpath build_onefile `
            --icon assets/icons/chroniclemap.ico `
            --hidden-import PySide6.QtCore `
            --hidden-import PySide6.QtGui `
            --hidden-import PySide6.QtWidgets `
            --add-data "chroniclemap/gui/locales;chroniclemap/gui/locales" `
            chroniclemap/gui/__main__.py

      - name: Build onedir package
        run: |
          poetry run python -m PyInstaller `
            --noconfirm `
            --clean `
            --windowed `
            --onedir `
            --name ChronicleMap `
            --distpath dist_onedir `
            --workpath build_onedir `
            --icon assets/icons/chroniclemap.ico `
            --hidden-import PySide6.QtCore `
            --hidden-import PySide6.QtGui `
            --hidden-import PySide6.QtWidgets `
            --add-data "chroniclemap/gui/locales;chroniclemap/gui/locales" `
            chroniclemap/gui/__main__.py

      - name: Prepare release assets
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null
          $onefile = "ChronicleMap-v$env:VERSION-windows-x64-onefile.exe"
          Copy-Item "dist_onefile/ChronicleMap.exe" "dist/$onefile" -Force

          $zipName = "ChronicleMap-v$env:VERSION-windows-x64-onedir.zip"
          if (Test-Path "dist/$zipName") { Remove-Item "dist/$zipName" -Force }
          Compress-Archive -Path "dist_onedir/ChronicleMap/*" -DestinationPath "dist/$zipName"

          "RELEASE_ASSET_ONEFILE=dist/$onefile" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "RELEASE_ASSET_ONEDIR=dist/$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ChronicleMap-windows-packages
          path: |
            ${{ env.RELEASE_ASSET_ONEFILE }}
            ${{ env.RELEASE_ASSET_ONEDIR }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.RELEASE_ASSET_ONEFILE }}
            ${{ env.RELEASE_ASSET_ONEDIR }}
          generate_release_notes: true
